---
import { Image } from 'astro:assets';

import AuthorMeta from '../../components/AuthorMeta.astro';
import Link from '../../components/Link.astro';
import MorePosts from '../../components/MorePosts.astro';
import PageInfo from '../../components/PageInfo.astro';
import Prose from '../../components/Prose.astro';
import SharePost from '../../components/SharePost.astro';
import TagList from '../../components/TagList.astro';
import TocWidget from '../../components/TocWidget.astro';
import Base from '../../layouts/Base.astro';
import { getAllEntries } from '../../modules/common';
import {
  getHeadingsForTableOfContents,
  getMorePostsWithRenderedMarkdownDescription,
  getPostSlug,
  getRandomPosts,
} from '../../modules/post';

export async function getStaticPaths() {
  const sortedPosts = await getAllEntries('blog');

  const paths = sortedPosts.map((post) => {
    const slug = getPostSlug(post);
    const randomPosts = getRandomPosts(sortedPosts, 4, slug);

    return {
      params: { slug },
      props: { ...post, randomPosts },
    };
  });

  return paths;
}

const { id, data, render, randomPosts } = Astro.props;
const {
  draft,
  title,
  pubDate,
  updatedDate,
  description,
  toc,
  heroImage,
  heroAlt,
  noHero,
  category,
  tags = [],
} = data;

const { slug } = Astro.params;

const { Content, headings: postHeadings, remarkPluginFrontmatter } = await render();
const { readingTime } = remarkPluginFrontmatter;

const headings = getHeadingsForTableOfContents(postHeadings);
const morePosts = await getMorePostsWithRenderedMarkdownDescription(randomPosts);
---

{/* clean up all of this */}
<Base title={title} description={description} image={heroImage?.src}>
  <article class="mb-12" itemprop="blogPost" itemscope itemtype="http://schema.org/Article">
    <meta itemprop="mainEntityOfPage" content={`${slug}`} />
    {
      category && (
        <div class="leading-4 uppercase font-semibold">
          <Link href="#" variant="category">
            {category}
          </Link>
        </div>
      )
    }
    <Prose>
      <h1 itemprop="name headline" transition:name={`title-${slug!.replace(/.*\//, '')}`}>
        {title}
        {draft ? <sup class="text-red-400">(draft)</sup> : null}
      </h1>
      <TagList tags={tags} marginY />
      <PageInfo
        file={`src/content/blog/${id}`}
        pubDate={pubDate}
        updatedDate={updatedDate}
        readingTime={readingTime}
      />

      {
        !noHero && heroImage?.src && (
          <div class="lg:bustout">
            <Image
              src={heroImage}
              alt={heroAlt ?? ''}
              fetchpriority="high"
              loading="eager"
              width={1280}
              itemprop="image"
              class="!mt-0 w-full max-w-none"
              transition:name={`hero-${slug!.replace(/.*\//, '')}`}
            />
          </div>
        )
      }

      <AuthorMeta />

      <div itemprop="articleBody" transition:name={`content-${slug!.replace(/.*\//, '')}`}>
        {/* table of contents */}
        {toc && <TocWidget headings={headings} />}

        <Content />
      </div>
      <hr />

      <SharePost title={title} slug={slug} />
    </Prose>
  </article>

  <MorePosts morePosts={morePosts} />
</Base>
