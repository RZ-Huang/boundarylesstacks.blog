---
import { Image } from 'astro:assets';

import PostMeta from '@/components/PostMeta.astro';
import TagList from '@/components/TagList.astro';
import { ROUTES } from '@/constants/routes';
import { renderMarkdown } from '@/utils/markdown';
import { getRandomLengthSubstring } from '@/utils/strings';
import { cn } from '@/utils/styles';

import type { Post } from '@/types/post';

export interface Props {
  post: Post;
}

const { post } = Astro.props;
const { data, slug, readingTime } = post;

const {
  draft,
  publishDate,
  title,
  heroImage,
  heroAlt = '',
  // category,
  tags = [],
  description = '',
} = data;

// prepare all data for render

// ! this can break tags in markup
const clippedDescription = getRandomLengthSubstring(description, 100, 50) + '...';
const renderedDescription = await renderMarkdown(clippedDescription);

const postMetaProps = { readingTime, publishDate };
---

<article
  class="flex flex-col md:flex-row gap-4 py-4 lg:py-6 lg:gap-6 not-last:border-b border-base-300"
>
  {/* left column */}

  {/* image */}
  {
    heroImage && (
      <div class="md:basis-1/3">
        <Image
          src={heroImage}
          alt={heroAlt}
          widths={[320, 540, 720]}
          sizes="(max-width: 475px) 320px, (max-width: 720px) 540px, 720px"
          itemprop="image"
          class="w-full max-h-72 min-h-48 md:max-h-none md:h-full md:w-auto object-cover rounded-box"
          transition:name={`hero-${heroImage.src}`}
        />
      </div>
    )
  }

  {/* right column */}
  <div class="flex flex-col md:basis-2/3">
    <PostMeta {...postMetaProps} class="text-sm text-captions" />

    {/* title */}
    <h2 class="text-2xl font-bold break-words line-clamp-2 mb-2">
      <a href={`${ROUTES.BLOG}${slug}`} class="link-heading">
        {title}
        {draft && <sup class="text-sm text-red-400">(draft)</sup>}
      </a>
    </h2>

    {/* description, can have markdown */}
    <div class={cn('text-base mb-3', title?.length <= 48 ? 'line-clamp-2' : 'line-clamp-1')}>
      <Fragment set:html={renderedDescription.code} />
    </div>

    {/* tags */}
    <TagList tags={tags} class="mt-auto" />
  </div>
</article>
