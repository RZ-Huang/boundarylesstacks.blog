---
import { Image } from 'astro:assets';

import {
  getAllPosts,
  getHeadingsForTableOfContents,
  getMorePostsWithRenderedMarkdownDescription,
  getPostSlug,
  getRandomPosts,
} from '@/modules/post';
import Post from '@/layouts/Post.astro';
import MorePosts from '@/components/MorePosts.astro';
import PostMeta from '@/components/PostMeta.astro';
import SharePost from '@/components/SharePost.astro';
import TocWidget from '@/components/TocWidget.astro';

export async function getStaticPaths() {
  const sortedPosts = await getAllPosts();

  const paths = sortedPosts.map((post) => {
    const slug = getPostSlug(post);
    const randomPosts = getRandomPosts(sortedPosts, 4, slug);

    return {
      params: { slug },
      props: { ...post, randomPosts },
    };
  });

  return paths;
}

const { data, render, randomPosts } = Astro.props;
const {
  draft,
  title,
  publishDate,
  updatedDate,
  description,
  toc,
  heroImage,
  heroAlt,
  noHero,
  category,
  tags = [],
} = data;

const { slug } = Astro.params;

const { Content, headings: postHeadings, remarkPluginFrontmatter } = await render();
const { readingTime } = remarkPluginFrontmatter;

const headings = getHeadingsForTableOfContents(postHeadings);
const morePosts = await getMorePostsWithRenderedMarkdownDescription(randomPosts);

const postMetaProps = {
  category,
  publishDate,
  readingTime,
  updatedDate,
};
---

{/* clean up all of this */}
<Post title={title} description={description} image={heroImage.src}>
  <Fragment slot="hero-image">
    {/* hero image 1280x720 max, 16:9 */}
    {
      !noHero && (
        <Image
          src={heroImage}
          alt={heroAlt}
          fetchpriority="high"
          loading="eager"
          itemprop="image"
          class="block max-w-full h-auto aspect-[16/7] object-cover"
          widths={[320, 540, 720, 1024]}
          sizes="(max-width: 475px) 320px, (max-width: 720px) 540px, (max-width: 1280px) 720px, 1024px"
        />
      )
    }
  </Fragment>

  <Fragment slot="hero-text">
    {/* title */}
    <h1>
      {title}
      {draft && <sup class="text-red-400">(draft)</sup>}
    </h1>

    {/* description */}
    {description && <h2 class="mt-0 mb-3 font-normal text-xl lg:text-2xl">{description}</h2>}

    {/* meta */}
    <PostMeta {...postMetaProps} />
  </Fragment>

  {/* section content */}
  <Fragment slot="content">
    {/* table of contents */}
    {toc && false && <TocWidget headings={headings} />}

    <Content />

    <!-- <TagList tags={tags} marginY /> -->

    <SharePost title={title} slug={slug} />
  </Fragment>

  <Fragment slot="more-posts">
    <MorePosts morePosts={morePosts} />
  </Fragment>
</Post>
